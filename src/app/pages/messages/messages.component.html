<mat-drawer-container class="h-100 min-vh-100 bg-primary-pale">
  <!-- Sidebar: Chat List -->
  <mat-drawer #drawer mode="side" class="w-100 w-md-25 bg-primary-lighter shadow-lg p-0">
    <div class="p-3 border-bottom border-primary d-flex align-items-center justify-content-between">
      <span class="fw-bold text-primary fs-5">Chats</span>
      <button mat-icon-button color="primary" (click)="drawer.toggle()" class="d-md-none">
        <mat-icon>menu</mat-icon>
      </button>
    </div>
    <div class="overflow-auto" style="max-height: 80vh;">
      <ng-container *ngFor="let friendName of friendChats; trackBy: trackByFn">
        <mat-card
          class="mb-2 cursor-pointer shadow-sm animate__animated animate__fadeIn"
          [ngClass]="{
            'bg-primary text-white': chattingChatId === friendName[1],
            'bg-white text-primary': chattingChatId !== friendName[1]
          }"
          (click)="openChatWindow(friendName[1], friendName[0], friendName[2])"
        >
          <mat-card-header>
            <span class="fw-semibold">{{ friendName[0] }}</span>
          </mat-card-header>
        </mat-card>
      </ng-container>
      <button mat-raised-button color="primary" class="w-100 mt-3" (click)="createNewChat()">
        <mat-icon class="me-1">add</mat-icon> New Chat
      </button>
    </div>
  </mat-drawer>

  <!-- Main Chat Area -->
  <mat-drawer-content class="bg-primary-light d-flex flex-column h-100">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between px-4 py-3 bg-primary-lighter border-bottom border-primary">
      <div class="fs-5 fw-bold text-primary">
        <ng-container *ngIf="currentChatName; else noChat">
          Chatting with: <span class="text-primary">{{ currentChatName }}</span>
        </ng-container>
        <ng-template #noChat>
          <span class="text-muted">Select a chat</span>
        </ng-template>
      </div>
      <button mat-icon-button color="primary" class="d-md-none" (click)="drawer.toggle()">
        <mat-icon>{{ drawer.opened ? 'arrow_back_ios' : 'menu' }}</mat-icon>
      </button>
    </div>

    <!-- Messages List -->
    <div class="flex-grow-1 overflow-auto px-3 py-3 animate__animated animate__fadeIn">
      <ng-container *ngFor="let message of chatMessages; trackBy: trackByMessage">
        <div class="d-flex mb-3"
             [ngClass]="{'justify-content-end': message.owner === loggedInUser?.displayName}">
          <div class="p-3 rounded-4 shadow-sm"
               [ngClass]="{
                 'bg-primary text-white': message.owner === loggedInUser?.displayName,
                 'bg-primary-light text-primary': message.owner !== loggedInUser?.displayName
               }">
            <div class="fw-semibold small mb-1">{{ message.owner }}</div>
            <div class="break-word">{{ message.text }}</div>
            <ng-container *ngIf="loggedInOwnerInGroup || loggedInModInGroup">
              <button mat-icon-button color="warn" class="ms-2" (click)="deleteMessageFromChat(message.id)">
                <mat-icon>delete_forever</mat-icon>
              </button>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Message Input -->
    <div class="border-top border-primary bg-primary-lighter px-3 py-3 d-flex align-items-center gap-2 sticky-bottom">
      <mat-form-field class="flex-grow-1 m-0">
        <textarea matInput cdkTextareaAutosize style="max-height: 30vh" [formControl]="messageToSend" placeholder="Type your message..."></textarea>
      </mat-form-field>
      <div class="d-flex flex-column justify-content-center align-items-center">
        <button mat-fab color="primary" type="button" class="btn btn-primary-light text-white d-flex align-items-center justify-content-center shadow" (click)="onSend(chattingChatId)">
          <mat-icon>send</mat-icon>
        </button>
      </div>
      <button *ngIf="loggedInOwnerInGroup"
              mat-raised-button color="warn"
              class="ms-2"
              (click)="deleteChat(chattingChatId)">
        <mat-icon>delete</mat-icon> Delete Chat
      </button>
    </div>
  </mat-drawer-content>
</mat-drawer-container>

